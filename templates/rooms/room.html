{% extends "base.html" %}
{% block title %}{{ room.name }} | FocusBuddy{% endblock %}

{% block content %}
<section class="auth-card">
  <h1 style="margin-bottom:.25rem;">
    {{ room.name }}
    {% if is_owner %}
      <span class="muted" style="font-size:.95rem;">(Owner)</span>
    {% endif %}
  </h1>

  <p class="muted">
    Room ID: <strong>#{{ room.id }}</strong> Â· Members: <strong><span id="members-count">{{ member_count }}</span></strong>
  </p>

  {% if room.join_code %}
  <div class="card" style="margin-top: 1rem;">
    <h3 style="margin:0 0 .5rem;">Invite</h3>

    <p style="margin:0 0 .5rem;">
      Join code:
      <strong style="letter-spacing:.08em;">
        {{ room.join_code }}
      </strong>
    </p>

    {% if invite_link %}
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <input
          type="text"
          value="{{ invite_link }}"
          id="inviteLink"
          readonly
          style="flex:1; padding:.6rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05); color:#fff;"
        />

        <button
          class="btn secondary"
          type="button"
          onclick="copyInviteLink()"
        >
          Copy Link
        </button>
      </div>
    {% endif %}
  </div>
{% endif %}

  <div class="card" style="margin-top: 1rem;">
    <h3 style="margin:0 0 .75rem;">Members</h3>

    <ul id="members-list" style="list-style:none; padding:0; margin:0; display:grid; gap:.45rem;">
      {% for user, is_room_owner in members %}
  <li style="display:flex; align-items:center; justify-content:space-between;">
    <span>
      {{ user.username | title }}
      {% if user.id == room.owner_id %}
        <strong style="margin-left:.35rem;">ðŸ‘‘</strong>
      {% endif %}
    </span>
  </li>
{% endfor %}
    </ul>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h3 style="margin-top:0;">Focus Session</h3>

    <p class="muted" style="margin:.25rem 0 0;">
      Status: <strong id="fs-status">idle</strong>
    </p>

    <div style="display:flex; gap:.75rem; align-items:center; margin-top:.75rem; flex-wrap:wrap;">
      <div style="font-size:2rem; font-weight:800;" id="fs-timer">25:00</div>

      <form method="post" action="{{ url_for('rooms.room_session_start', room_id=room.id) }}" style="margin:0; display:flex; gap:.5rem; align-items:center;">
        <input name="minutes" type="number" min="1" max="180" value="25" style="width:90px;">
        <button class="btn primary" type="submit">Start</button>
      </form>

      <form method="post" action="{{ url_for('rooms.room_session_pause', room_id=room.id) }}" style="margin:0;">
        <button class="btn secondary" type="submit">Pause</button>
      </form>

      <form method="post" action="{{ url_for('rooms.room_session_resume', room_id=room.id) }}" style="margin:0;">
        <button class="btn secondary" type="submit">Resume</button>
      </form>

      <form method="post" action="{{ url_for('rooms.room_session_reset', room_id=room.id) }}" style="margin:0;">
        <button class="btn secondary" type="submit">Reset</button>
      </form>

      <form method="post" action="{{ url_for('rooms.room_session_end', room_id=room.id) }}" style="margin:0;">
        <button class="btn danger minimal" type="submit">End</button>
      </form>
    </div>
  </div>

  <div class="actions" style="margin-top: 1.25rem; flex-wrap: wrap;">
    <a class="btn secondary" href="{{ url_for('rooms.rooms_index') }}">Back to Rooms</a>

    {% if is_owner %}
      <form method="post"
        action="{{ url_for('rooms.room_delete', room_id=room.id) }}"
        style="margin:0;">
      <button class="btn danger minimal"
          type="submit"
          onclick="return confirm('Delete this room? This cannot be undone.');">
        Delete
      </button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('rooms.room_leave', room_id=room.id) }}" style="margin:0;">
        <button class="btn secondary" type="submit"
                onclick="return confirm('Leave this room?');">
          Leave Room
        </button>
      </form>
    {% endif %}

  </div>
</section>

<script>
  function fmt(seconds) {
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(Math.floor(seconds % 60)).padStart(2, "0");
    return `${m}:${s}`;
  }

  async function copyInviteLink() {
    const input = document.getElementById("inviteLink");
    if (!input) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(input.value);
      } else {
        input.select();
        document.execCommand('copy');
      }
      const btn = input.nextElementSibling;
      if (btn && btn.tagName === 'BUTTON') {
        const orig = btn.textContent;
        btn.textContent = "Copied!";
        setTimeout(() => btn.textContent = orig, 1500);
      }
    } catch (_) {}
  }

  async function pollSession() {
    try {
      const res = await fetch("{{ url_for('rooms.room_session_status', room_id=room.id) }}", { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();

      const statusEl = document.getElementById("fs-status");
      const timerEl = document.getElementById("fs-timer");

      if (statusEl) statusEl.textContent = data.status || "idle";
      if (timerEl) timerEl.textContent = fmt(data.remaining_seconds ?? 1500);
    } catch (_) {}
  }

  async function pollPresence() {
    try {
      const res = await fetch("{{ url_for('rooms.room_presence', room_id=room.id) }}", { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();

      const countEl = document.getElementById("members-count");
      if (countEl) countEl.textContent = data.count ?? 0;
    } catch (_) {}
  }

  pollSession();
  pollPresence();
  setInterval(pollSession, 1000);
  setInterval(pollPresence, 5000);
</script>
{% endblock %}